<!-- çœç•¥ã›ãšãƒ•ãƒ«ã§å‹•ãç‰ˆ -->
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>åˆ¶ä½œãƒ©ãƒ³ã‚¯ã‚·ã‚¹ãƒ†ãƒ  å®Œå…¨ç‰ˆ</title>
<link href="https://fonts.googleapis.com/css2?family=Bangers&family=Orbitron:wght@500&display=swap" rel="stylesheet">

<style>
body { font-family: Arial; text-align: center; background: #fff; }
.container { margin-top: 20px; }
button { padding: 8px 18px; font-size: 16px; margin: 5px; }

#timer {
    font-family: 'Orbitron';
    font-size: 50px;
    color: #0d6efd;
    -webkit-text-stroke: 0.6px #004080;
}

#rank { font-family: 'Bangers'; font-size: 36px; }

#totalHours {
    font-size: 34px;
    color: #333;
    -webkit-text-stroke: 0.5px #666;
}

.progress { width: 80%; height: 25px; background: #ddd; margin: 15px auto; border-radius: 20px; }
.progress-bar { height: 100%; width: 0%; background: gold; border-radius: 20px; }

#calendar {
    display: grid;
    grid-template-columns: repeat(7, 40px);
    grid-gap: 5px;
    justify-content: center;
    margin-top: 20px;
}
.day {
    width: 40px; height: 40px;
    line-height: 40px;
    border-radius: 5px;
    background: #fff;
    border: 1px solid #000;
    cursor: pointer;
}
.day.active { background: #28a745; color: #fff; }
</style>
</head>

<body>
<div class="container">

<h1>åˆ¶ä½œãƒ©ãƒ³ã‚¯ã‚·ã‚¹ãƒ†ãƒ </h1>

<p>ç´¯è¨ˆæ™‚é–“: <span id="totalHours">0</span> h</p>
<p>ç¾åœ¨ã®ãƒ©ãƒ³ã‚¯: <span id="rank">ãƒ–ãƒ­ãƒ³ã‚º I</span></p>
<p>æ¬¡ã®ãƒ©ãƒ³ã‚¯ã¾ã§: <span id="nextRank">4</span> h</p>

<div id="timer">00:00:00</div>

<button onclick="addTime()">+30åˆ†</button>
<button onclick="startTimer()">ã‚¹ã‚¿ãƒ¼ãƒˆ/ä¸€æ™‚åœæ­¢</button>
<button onclick="resetTimer()">ã‚¿ã‚¤ãƒãƒ¼ãƒªã‚»ãƒƒãƒˆ</button>
<button onclick="resetData()">ç´¯è¨ˆãƒªã‚»ãƒƒãƒˆ</button>
<button onclick="addTestHours()">+10æ™‚é–“ï¼ˆãƒ†ã‚¹ãƒˆï¼‰</button>

<div class="progress"><div class="progress-bar" id="progressBar"></div></div>

<div>
<button onclick="changeMonth(-1)">â—€ å‰æœˆ</button>
<span id="monthLabel">2026å¹´3æœˆ</span>
<button onclick="changeMonth(1)">æ¬¡æœˆ â–¶</button>
</div>

<div id="monthTotal">ä»Šæœˆåˆè¨ˆ: 0 h</div>
<div id="calendar"></div>

</div>

<script>
const ranks = [
{ name:"ãƒ–ãƒ­ãƒ³ã‚º I", hours:0, color:"#ff9900", stroke:"#cc6600" },
{ name:"ãƒ–ãƒ­ãƒ³ã‚º II", hours:4, color:"#ff9900", stroke:"#cc6600" },
{ name:"ãƒ–ãƒ­ãƒ³ã‚º III", hours:11, color:"#ff9900", stroke:"#cc6600" },
{ name:"ã‚·ãƒ«ãƒãƒ¼ I", hours:20, color:"#c0c0c0", stroke:"#808080" },
{ name:"ã‚·ãƒ«ãƒãƒ¼ II", hours:29, color:"#c0c0c0", stroke:"#808080" },
{ name:"ã‚·ãƒ«ãƒãƒ¼ III", hours:43, color:"#c0c0c0", stroke:"#808080" },
{ name:"ã‚´ãƒ¼ãƒ«ãƒ‰ I", hours:60, color:"#ffd700", stroke:"#ccaa00" },
{ name:"ã‚´ãƒ¼ãƒ«ãƒ‰ II", hours:78, color:"#ffd700", stroke:"#ccaa00" },
{ name:"ã‚´ãƒ¼ãƒ«ãƒ‰ III", hours:104, color:"#ffd700", stroke:"#ccaa00" },
{ name:"ãƒ—ãƒ©ãƒãƒŠ I", hours:140, color:"#d0e0e3", stroke:"#9fb8bd" },
{ name:"ãƒ—ãƒ©ãƒãƒŠ II", hours:178, color:"#d0e0e3", stroke:"#9fb8bd" },
{ name:"ãƒ—ãƒ©ãƒãƒŠ III", hours:232, color:"#d0e0e3", stroke:"#9fb8bd" },
{ name:"ãƒ€ã‚¤ãƒ¤ãƒ¢ãƒ³ãƒ‰ I", hours:300, color:"#00ffff", stroke:"#009999" },
{ name:"ãƒ€ã‚¤ãƒ¤ãƒ¢ãƒ³ãƒ‰ II", hours:372, color:"#00ffff", stroke:"#009999" },
{ name:"ãƒ€ã‚¤ãƒ¤ãƒ¢ãƒ³ãƒ‰ III", hours:476, color:"#00ffff", stroke:"#009999" },
{ name:"ã‚«ãƒ¼ãƒœãƒŠãƒ‰", hours:620, color:"#8b0000", stroke:"#550000" },
{ name:"ãƒ‘ãƒ©ã‚´ãƒ³", hours:1260, color:"#4b0082", stroke:"#2e004d" },
{ name:"ã‚ªãƒ ãƒ‹ã‚¹", hours:2540, color:"#00ff99", stroke:"#009966" }
];

let totalHours = 0;
let timerInterval = null;
let remainingSeconds = 0;

// ================== ã‚¿ã‚¤ãƒãƒ¼ ==================

function addTime(){
    remainingSeconds += 1800; // 30åˆ†è¿½åŠ 
    updateTimerDisplay();
}

function startTimer(){

    if(timerInterval){
        clearInterval(timerInterval);
        timerInterval = null;
        return;
    }

    if(remainingSeconds <= 0) return;

    timerInterval = setInterval(() => {

        remainingSeconds--;
        updateTimerDisplay();

        if(remainingSeconds <= 0){
            clearInterval(timerInterval);
            timerInterval = null;

            totalHours += 0.5; // 30åˆ†å®Œäº†
            updateDisplay();
        }

    },1000);
}

function resetTimer(){
    clearInterval(timerInterval);
    timerInterval = null;
    remainingSeconds = 0;
    updateTimerDisplay();
}

function updateTimerDisplay(){
    const h = String(Math.floor(remainingSeconds/3600)).padStart(2,"0");
    const m = String(Math.floor((remainingSeconds%3600)/60)).padStart(2,"0");
    const s = String(remainingSeconds%60).padStart(2,"0");
    document.getElementById("timer").innerText = `${h}:${m}:${s}`;
}

// ================== ç´¯è¨ˆç³» ==================

function addTestHours(){
    totalHours += 10;
    updateDisplay();
}

function resetData(){
    totalHours = 0;
    updateDisplay();
}

// ================== ãƒ©ãƒ³ã‚¯è¡¨ç¤º ==================

function updateDisplay(){

    document.getElementById("totalHours").innerText = totalHours.toFixed(1);

    let currentRank=ranks[0], nextRank=null;

    for(let i=0;i<ranks.length;i++){
        if(totalHours>=ranks[i].hours){
            currentRank=ranks[i];
            nextRank=ranks[i+1];
        }
    }

    const rankEl=document.getElementById("rank");
    rankEl.innerText=currentRank.name;
    rankEl.style.color=currentRank.color;
    rankEl.style.webkitTextStroke="0.6px "+currentRank.stroke;

    if(nextRank){
        document.getElementById("nextRank").innerText=(nextRank.hours-totalHours).toFixed(1);
    } else {
        document.getElementById("nextRank").innerText="é”æˆæ¸ˆã¿";
    }
}

// ================== ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ ==================

let currentDate = new Date();

function changeMonth(offset){
    currentDate.setMonth(currentDate.getMonth()+offset);
    renderCalendar();
}

function renderCalendar(){

    const year=currentDate.getFullYear();
    const month=currentDate.getMonth();

    document.getElementById("monthLabel").innerText=`${year}å¹´${month+1}æœˆ`;

    const calendar=document.getElementById("calendar");
    calendar.innerHTML="";

    const firstDay=new Date(year,month,1).getDay();
    const daysInMonth=new Date(year,month+1,0).getDate();

    for(let i=0;i<firstDay;i++){
        calendar.innerHTML+="<div></div>";
    }

    for(let d=1;d<=daysInMonth;d++){
        const day=document.createElement("div");
        day.className="day";
        day.innerText=d;
        calendar.appendChild(day);
    }
}

updateTimerDisplay();
updateDisplay();
renderCalendar();
    
 </script>
 <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<!-- æ—¢å­˜ã® supabase å®£è¨€ãƒ»ãƒ©ãƒ³ã‚­ãƒ³ã‚°ç³»ã‚’ä¸¸ã”ã¨ç½®ãæ›ãˆ -->
<script>
const supabaseUrl = "https://vfgfunxzthogghymrnnq.supabase.co";
const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZmZ2Z1bnh6dGhvZ2doeW1ybm5xIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIzMTQzMDQsImV4cCI6MjA4Nzg5MDMwNH0.HA0wze4yqkq1XebULhpyDUqQkgRe4xIoHUBTB65bM-o";

// â† ã“ã“ãŒé‡è¤‡ã—ã¦å®£è¨€ã•ã‚Œã¦ã„ãŸå ´åˆã€å¤ã„ã®ã‚’æ¶ˆã—ã¦ç½®ãæ›ãˆã‚‹
const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
console.log("Supabaseæ¥ç¶šæˆåŠŸ:", supabase);

let liveTotalSeconds = 0;
let liveWeeklySeconds = 0;
let liveMonthlySeconds = 0;
let liveCounter = 0;
const userName = "testuser"; // å¾Œã§ãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ç½®ãæ›ãˆ

function tickTimer(){
    liveTotalSeconds++;
    liveWeeklySeconds++;
    liveMonthlySeconds++;
    liveCounter++;
    if(liveCounter >= 60){ // 1åˆ†åˆ»ã¿ã§ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆ
        liveCounter = 0;
        let record = {
            username: userName,
            total_minutes: Math.floor(liveTotalSeconds / 60),
            weekly_minutes: Math.floor(liveWeeklySeconds / 60),
            monthly_minutes: Math.floor(liveMonthlySeconds / 60),
            created_at: new Date().toISOString()
        };
        record = resetIfNeeded(record);
        supabase.from("records")
            .upsert(record)
            .then(() => updateRanking())
            .catch(err => console.error("upsert error:", err));
    }
}

function startLiveTimer(){ setInterval(tickTimer, 1000); }

function resetIfNeeded(record){
    const now = new Date();
    const monday = new Date(now);
    monday.setDate(now.getDate() - now.getDay() + 1);
    monday.setHours(0,0,0,0);

    const lastWeek = new Date(record.created_at);
    lastWeek.setHours(0,0,0,0);
    if(lastWeek < monday) record.weekly_minutes = 0;

    const currentMonth = now.getMonth();
    const lastMonth = new Date(record.created_at).getMonth();
    if(currentMonth !== lastMonth) record.monthly_minutes = 0;

    return record;
}

async function updateRanking(){
    const totalRank = await fetchRanking("total_minutes");
    const weekRank = await fetchRanking("weekly_minutes");
    const monthRank = await fetchRanking("monthly_minutes");

    renderRanking("totalRank", totalRank, "total_minutes");
    renderRanking("weekRank", weekRank, "weekly_minutes");
    renderRanking("monthRank", monthRank, "monthly_minutes");
}

async function fetchRanking(column){
    const { data } = await supabase
        .from("records")
        .select("*")
        .order(column, { ascending: false })
        .limit(100);
    return data || [];
}

function renderRanking(elementId, data, column){
    const div = document.getElementById(elementId);
    div.innerHTML = "";
    data.forEach((user, index) => {
        let medal = "";
        if(index === 0) medal = "ğŸ¥‡ ";
        else if(index === 1) medal = "ğŸ¥ˆ ";
        else if(index === 2) medal = "ğŸ¥‰ ";
        div.innerHTML += `<p>${medal}${index+1}ä½ ${user.username} - ${user[column]}åˆ†</p>`;
    });
}

// èµ·å‹•æ™‚ã«å‘¼ã¶
startLiveTimer();
</script>
<div>
  <h2>ç·åˆãƒ©ãƒ³ã‚­ãƒ³ã‚°</h2>
  <div id="totalRank"></div>

  <h2>ä»Šé€±ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h2>
  <div id="weekRank"></div>

  <h2>ä»Šæœˆãƒ©ãƒ³ã‚­ãƒ³ã‚°</h2>
  <div id="monthRank"></div>
</div>
</body>
</html>
