<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>制作ランクシステム タイマー＋カレンダー</title>
<style>
body {
    font-family: Arial;
    text-align: center;
    background: #111;
    color: white;
}
.container {
    margin-top: 20px;
}
button {
    padding: 8px 18px;
    font-size: 16px;
    margin: 5px;
}
.progress {
    width: 80%;
    height: 25px;
    background: #333;
    margin: 15px auto;
    border-radius: 20px;
}
.progress-bar {
    height: 100%;
    width: 0%;
    background: gold;
    border-radius: 20px;
}
#timer {
    font-size: 35px;
    margin-top: 15px;
}
#calendar {
    display: grid;
    grid-template-columns: repeat(7, 40px);
    grid-gap: 5px;
    justify-content: center;
    margin-top: 20px;
}
.day {
    width: 40px;
    height: 40px;
    line-height: 40px;
    border-radius: 5px;
    background: #333;
    cursor: pointer;
}
.day.active {
    background: #28a745;
}
#monthTotal {
    margin-top: 10px;
    font-size: 18px;
}
</style>
</head>
<body>

<div class="container">
<h1>制作ランクシステム</h1>

<p>累計時間: <span id="totalHours">0</span> h</p>
<p>現在のランク: <span id="rank">ブロンズ I</span></p>
<p>次のランクまで: <span id="nextRank">4</span> h</p>

<div id="timer">00:00:00</div>

<button onclick="addTime()">+30分</button>
<button onclick="startTimer()">スタート/一時停止</button>
<button onclick="resetTimer()">タイマーリセット</button>
<button onclick="resetData()">累計リセット</button>

<div class="progress">
<div class="progress-bar" id="progressBar"></div>
</div>

<div id="monthTotal">今月合計: 0 h</div>
<div id="calendar"></div>
</div>

<script>
// --- ランク設定 ---
const ranks = [
{ name: "ブロンズ I", hours: 0 },
{ name: "ブロンズ II", hours: 4 },
{ name: "ブロンズ III", hours: 11 },
{ name: "シルバー I", hours: 20 },
{ name: "シルバー II", hours: 29 },
{ name: "シルバー III", hours: 43 },
{ name: "ゴールド I", hours: 60 },
{ name: "ゴールド II", hours: 78 },
{ name: "ゴールド III", hours: 104 },
{ name: "プラチナ I", hours: 140 },
{ name: "プラチナ II", hours: 178 },
{ name: "プラチナ III", hours: 232 },
{ name: "ダイヤモンド I", hours: 300 },
{ name: "ダイヤモンド II", hours: 372 },
{ name: "ダイヤモンド III", hours: 476 },
{ name: "カーボナド", hours: 620 },
{ name: "パラゴン", hours: 1260 },
{ name: "オムニス", hours: 2540 }
];

// --- 保存データ読み込み ---
let totalHours = parseFloat(localStorage.getItem("totalHours")) || 0;
let timerSeconds = parseInt(localStorage.getItem("timerSeconds")) || 0;
let dailyData = JSON.parse(localStorage.getItem("dailyData")) || {};
let timerRunning = false;
let interval = null;

// --- 日付取得 ---
function getTodayKey() {
    const today = new Date();
    return today.getFullYear() + "-" + (today.getMonth()+1) + "-" + today.getDate();
}

// --- タイマー操作 ---
function addTime() {
    timerSeconds += 30 * 60;
    updateTimerDisplay();
    saveTimer();
}

function startTimer() {
    if (timerRunning) {
        clearInterval(interval);
        timerRunning = false;
    } else {
        timerRunning = true;
        interval = setInterval(() => {
            if (timerSeconds > 0) {
                timerSeconds--;
                updateTimerDisplay();
                saveTimer();
            } else {
                clearInterval(interval);
                timerRunning = false;
                // タイマー終了時に累計＆日別に反映
                totalHours += 0.5;
                saveData();
                const key = getTodayKey();
                dailyData[key] = (dailyData[key] || 0) + 0.5;
                saveDailyData();
                updateDisplay();
                alert("タイマー終了！累計に0.5h加算されました");
            }
        }, 1000);
    }
}

function resetTimer() {
    clearInterval(interval);
    timerRunning = false;
    timerSeconds = 0;
    updateTimerDisplay();
    saveTimer();
}

function resetData() {
    totalHours = 0;
    dailyData = {};
    saveData();
    saveDailyData();
    updateDisplay();
}

// --- localStorage保存 ---
function saveData() {
    localStorage.setItem("totalHours", totalHours);
}
function saveTimer() {
    localStorage.setItem("timerSeconds", timerSeconds);
}
function saveDailyData() {
    localStorage.setItem("dailyData", JSON.stringify(dailyData));
}

// --- タイマー表示 ---
function updateTimerDisplay() {
    let h = Math.floor(timerSeconds / 3600);
    let m = Math.floor((timerSeconds % 3600) / 60);
    let s = timerSeconds % 60;
    document.getElementById("timer").innerText =
        (h<10?"0":"")+h+":"+(m<10?"0":"")+m+":"+(s<10?"0":"")+s;
}

// --- ランクとゲージ更新 ---
function updateDisplay() {
    document.getElementById("totalHours").innerText = totalHours.toFixed(1);

    let currentRank = ranks[0];
    let nextRank = ranks[1];
    for (let i = 0; i < ranks.length; i++) {
        if (totalHours >= ranks[i].hours) {
            currentRank = ranks[i];
            nextRank = ranks[i + 1];
        }
    }

    document.getElementById("rank").innerText = currentRank.name;

    if (nextRank) {
        let remaining = (nextRank.hours - totalHours).toFixed(1);
        document.getElementById("nextRank").innerText = remaining;

        let progressPercent = ((totalHours - currentRank.hours) /
        (nextRank.hours - currentRank.hours)) * 100;
        document.getElementById("progressBar").style.width = progressPercent + "%";
    } else {
        document.getElementById("nextRank").innerText = "達成済み";
        document.getElementById("progressBar").style.width = "100%";
    }

    updateCalendar();
}

// --- カレンダー生成 ---
function generateCalendar() {
    const calendar = document.getElementById("calendar");
    calendar.innerHTML = "";
    const today = new Date();
    const year = today.getFullYear();
    const month = today.getMonth();
    const firstDay = new Date(year, month, 1).getDay();
    const lastDate = new Date(year, month+1, 0).getDate();

    // 空白埋め
    for (let i = 0; i < firstDay; i++) {
        const empty = document.createElement("div");
        calendar.appendChild(empty);
    }

    // 日付生成
    for (let d = 1; d <= lastDate; d++) {
        const dayDiv = document.createElement("div");
        dayDiv.className = "day";
        dayDiv.innerText = d;

        const key = year + "-" + (month+1) + "-" + d;
        if (dailyData[key] && dailyData[key] > 0) {
            dayDiv.classList.add("active");
        }

        dayDiv.onclick = () => {
            const hours = dailyData[key] ? dailyData[key].toFixed(1) : 0;
            alert(`${key} の勉強時間: ${hours} h`);
        }

        calendar.appendChild(dayDiv);
    }
}

// --- カレンダー更新と月合計 ---
function updateCalendar() {
    generateCalendar();
    const today = new Date();
    const year = today.getFullYear();
    const month = today.getMonth()+1;

    let monthSum = 0;
    for (const key in dailyData) {
        if (key.startsWith(year+"-"+month)) {
            monthSum += dailyData[key];
        }
    }
    document.getElementById("monthTotal").innerText = `今月合計: ${monthSum.toFixed(1)} h`;
}

// --- 初期表示 ---
updateTimerDisplay();
updateDisplay();
